<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="description" content="How devs read BIPs.">
    <meta name="keywords" content="bitcoin, bitcoin improvement proposals, bip, bips, static, share">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>BIP 144: Segregated Witness (Peer Services)</title>

    <link rel="stylesheet" href="/style.css" />
    <script defer data-domain="bips.dev" src="/js/script.js"></script>

    <!-- dark mode: https://tailwindcss.com/docs/dark-mode -->
    <script>
        window.setTheme = function() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark')
            } else {
                document.documentElement.classList.remove('dark')
            }
        }

        window.setTheme()
    </script>
</head>

<body class="bg-white dark:bg-zinc-900">
    <div class="container mx-auto flex justify-center">
        <div class="min-w-full max-w-full lg:min-w-[1000px] lg:max-w-[1000px] px-6 py-10 space-y-10 text-slate-700 dark:text-gray-300">
            
    <div class="flex flex-col space-y-4 pt-4 md:pt-8">
        <div class="flex justify-between">
            <a href="/">Back to BIPs</a>
            <div class="flex">
                <svg id="toggleDark_light" class="hidden dark:flex w-6 h-6 hover:cursor-pointer" onclick="localStorage.theme = 'light'; window.setTheme()"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                </svg>
                <svg id="toggleDark_dark" class="flex dark:hidden w-6 h-6 hover:cursor-pointer" onclick="localStorage.theme = 'dark'; window.setTheme()"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
                </svg>
            </div>
        </div>
        <div class="flex flex-col space-y-2">
            <div class="text-2xl font-extrabold">BIP 144: Segregated Witness (Peer Services)</div>
            <div class="flex justify-between">
                <div class="text-xl font-semibold">2016-01-08</div>
                <a href="https:&#x2F;&#x2F;github.com&#x2F;bitcoin&#x2F;bips&#x2F;blob&#x2F;master&#x2F;bip-0144.mediawiki" target="_blank">View on GitHub</a>
            </div>
        </div>

        <article class="max-w-none prose prose-lg prose-zinc prose-p:leading-relaxed prose-a:font-bold prose-a:underline prose-a:decoration-2 prose-a:decoration-bitcoin prose-pre:bg-zinc-200 prose-pre:text-zinc-800 dark:prose-invert dark:prose-pre:bg-zinc-600 dark:prose-pre:text-white">
            <pre><code>  BIP: 144
  Layer: Peer Services
  Title: Segregated Witness (Peer Services)
  Author: Eric Lombrozo &lt;elombrozo@gmail.com&gt;
          Pieter Wuille &lt;pieter.wuille@gmail.com&gt;
  Comments-Summary: No comments yet.
  Comments-URI: https:&#x2F;&#x2F;github.com&#x2F;bitcoin&#x2F;bips&#x2F;wiki&#x2F;Comments:BIP-0144
  Status: Final
  Type: Standards Track
  Created: 2016-01-08
  License: PD
</code></pre>
<h2>Abstract</h2>
<p>This BIP defines new messages and serialization formats for propagation of transactions and blocks committing to segregated witness structures.</p>
<h2>Motivation</h2>
<p>In addition to defining witness structures and requiring commitments in future blocks (<a href="/141" target="_blank">BIP141</a> - Consensus segwit BIP), new mechanisms must be defined to allow peers to advertise support for segregated witness and to relay the witness structures and request them from other peers without breaking compatibility with older nodes.</p>
<h2>Specification</h2>
<h3> Serialization </h3>
<p>A new serialization format for tx messages is added to the peer-to-peer protocol.</p>
<p>The serialization has the following structure:</p>
<table><thead><tr><th></th></tr></thead><tbody>
<tr><td>4</td></tr>
<tr><td>version</td></tr>
<tr><td>int32_t</td></tr>
<tr><td>Transaction data format version</td></tr>
<tr><td>1</td></tr>
<tr><td>marker</td></tr>
<tr><td>char</td></tr>
<tr><td>Must be zero</td></tr>
<tr><td>1</td></tr>
<tr><td>flag</td></tr>
<tr><td>char</td></tr>
<tr><td>Must be nonzero</td></tr>
<tr><td>1+</td></tr>
<tr><td>txin_count</td></tr>
<tr><td>var_int</td></tr>
<tr><td>Number of transaction inputs</td></tr>
<tr><td>41+</td></tr>
<tr><td>txins</td></tr>
<tr><td>txin[]</td></tr>
<tr><td>A list of one or more transaction inputs</td></tr>
<tr><td>1+</td></tr>
<tr><td>txout_count</td></tr>
<tr><td>var_int</td></tr>
<tr><td>Number of transaction outputs</td></tr>
<tr><td>9+</td></tr>
<tr><td>txouts</td></tr>
<tr><td>txouts[]</td></tr>
<tr><td>A list of one or more transaction outputs</td></tr>
<tr><td>1+</td></tr>
<tr><td>script_witnesses</td></tr>
<tr><td>script_witnesses[]</td></tr>
<tr><td>The witness structure as a serialized byte array</td></tr>
<tr><td>4</td></tr>
<tr><td>lock_time</td></tr>
<tr><td>uint32_t</td></tr>
<tr><td>The block number or timestamp until which the transaction is locked</td></tr>
</tbody></table>
<p>Parsers supporting this BIP will be able to distinguish between the old serialization format (without the witness) and this one. The marker byte is set to zero so that this structure will never parse as a valid transaction in a parser that does not support this BIP. If parsing were to succeed, such a transaction would contain no inputs and a single output.</p>
<p>If the witness is empty, the old serialization format must be used. </p>
<p>Currently, the only witness objects type supported are script witnesses which consist of a stack of byte arrays. It is encoded as a var_int item count followed by each item encoded as a var_int length followed by a string of bytes. Each txin has its own script witness. The number of script witnesses is not explicitly encoded as it is implied by txin_count. Empty script witnesses are encoded as a zero byte. The order of the script witnesses follows the same order as the associated txins.</p>
<ul>
<li>
<p><strong>Rationale for not having an independent message type with its own serialization</strong>: this would require separate &quot;tx&quot; and &quot;block&quot; messages, and all RPC calls operating on raw transactions would need to be duplicated, or need inefficient or nondeterministic guesswork to know which type is to be used.</p>
</li>
<li>
<p><strong>Rationale for not using just a single 0x00 byte as marker</strong>: that would lead to empty transactions (no inputs, no outputs, which are used in some tests) to be interpreted as new serialized data.</p>
</li>
<li>
<p><strong>Rationale for the 0x01 flag byte in between</strong>: this will allow us to easily add more extra non-committed data to transactions (like txouts being spent, ...). It can be interpreted as a bitvector.</p>
</li>
</ul>
<h3> Handshake </h3>
<p>A node will signal that it can provide witnesses using the following service bit</p>
<pre><code>    NODE_WITNESS = (1 &lt;&lt; 3)
	
</code></pre>
<h3> Hashes </h3>
<p>Transaction hashes used in the transaction merkle tree and txin outpoints are always computed using the old non-witness
serialization.</p>
<p>Support for a new hash including the witness data is added that is
computed from the new witness serialization. (Note that transactions
with an empty witness always use the old serialization,
and therefore, they have witness hash equal to normal hash.)</p>
<p><img src=bip-0144/witnesstx.png></img></p>
<h3> Relay </h3>
<p>New inv types MSG_WITNESS_TX (0x40000001, or (1&lt;&lt;30)+MSG_TX) and MSG_WITNESS_BLOCK (0x40000002, or (1&lt;&lt;30)+MSG_BLOCK) are added, only
for use in getdata. Inventory messages themselves still use just MSG_TX and MSG_BLOCK,
similar to MSG_FILTERED_BLOCK. A further inv type MSG_FILTERED_WITNESS_BLOCK (0x40000003, or (1&lt;&lt;30)+MSG_FILTERED_BLOCK) is reserved for future use.</p>
<ul>
<li><strong>Rationale for not advertizing witnessness in invs</strong>: we don't always use invs anymore (with 'sendheaders' BIP 130), plus it's not useful: implicitly, every transaction and block have a witness, old ones just have empty ones.</li>
</ul>
<p>MSG_WITNESS_TX getdata requests should use the non-witness serialized hash. The peer shall respond with a tx message, and if the witness structure is nonempty, the witness serialization shall be used.</p>
<p>MSG_WITNESS_BLOCK requests will return a block message with transactions that have a witness using witness serialization.</p>
<h2> Credits </h2>
<p>Special thanks to Gregory Maxwell for originating many of the ideas in this BIP and Luke-Jr for figuring out how to deploy this as a soft fork.</p>
<h2> Reference Implementation </h2>
<p>https://github.com/bitcoin/bitcoin/pull/8149</p>
<h2> Copyright </h2>
<p>This document is placed in the public domain.</p>

        </article>
    </div>

    <!--
    <div class="level">
        <div class="level-left">
            <div class="level-item">
                <a href="/"><img src="/bips-dev-header.png" width="375", height="100" /></a>
            </div>
        </div>
        <div class="level-right">
            <div class="level-item">
                <a href="/">Back to BIPs</a>
            </div>
        </div>
    </div>

    <p class="is-size-3 has-text-weight-bold mb-0">
      BIP 144: Segregated Witness (Peer Services)
    </p>
    <div class="level is-mobile">
        <div class="level-left">
            <div class="level-item">
                <p class="subtitle"><strong>2016-01-08</strong></p>
            </div>
        </div>
        <div class="level-right">
            <div class="level-item">
                <a href="https:&#x2F;&#x2F;github.com&#x2F;bitcoin&#x2F;bips&#x2F;blob&#x2F;master&#x2F;bip-0144.mediawiki">View on GitHub</a>
            </div>
        </div>
    </div>

    <div class="content">
      <pre><code>  BIP: 144
  Layer: Peer Services
  Title: Segregated Witness (Peer Services)
  Author: Eric Lombrozo &lt;elombrozo@gmail.com&gt;
          Pieter Wuille &lt;pieter.wuille@gmail.com&gt;
  Comments-Summary: No comments yet.
  Comments-URI: https:&#x2F;&#x2F;github.com&#x2F;bitcoin&#x2F;bips&#x2F;wiki&#x2F;Comments:BIP-0144
  Status: Final
  Type: Standards Track
  Created: 2016-01-08
  License: PD
</code></pre>
<h2>Abstract</h2>
<p>This BIP defines new messages and serialization formats for propagation of transactions and blocks committing to segregated witness structures.</p>
<h2>Motivation</h2>
<p>In addition to defining witness structures and requiring commitments in future blocks (<a href="/141" target="_blank">BIP141</a> - Consensus segwit BIP), new mechanisms must be defined to allow peers to advertise support for segregated witness and to relay the witness structures and request them from other peers without breaking compatibility with older nodes.</p>
<h2>Specification</h2>
<h3> Serialization </h3>
<p>A new serialization format for tx messages is added to the peer-to-peer protocol.</p>
<p>The serialization has the following structure:</p>
<table><thead><tr><th></th></tr></thead><tbody>
<tr><td>4</td></tr>
<tr><td>version</td></tr>
<tr><td>int32_t</td></tr>
<tr><td>Transaction data format version</td></tr>
<tr><td>1</td></tr>
<tr><td>marker</td></tr>
<tr><td>char</td></tr>
<tr><td>Must be zero</td></tr>
<tr><td>1</td></tr>
<tr><td>flag</td></tr>
<tr><td>char</td></tr>
<tr><td>Must be nonzero</td></tr>
<tr><td>1+</td></tr>
<tr><td>txin_count</td></tr>
<tr><td>var_int</td></tr>
<tr><td>Number of transaction inputs</td></tr>
<tr><td>41+</td></tr>
<tr><td>txins</td></tr>
<tr><td>txin[]</td></tr>
<tr><td>A list of one or more transaction inputs</td></tr>
<tr><td>1+</td></tr>
<tr><td>txout_count</td></tr>
<tr><td>var_int</td></tr>
<tr><td>Number of transaction outputs</td></tr>
<tr><td>9+</td></tr>
<tr><td>txouts</td></tr>
<tr><td>txouts[]</td></tr>
<tr><td>A list of one or more transaction outputs</td></tr>
<tr><td>1+</td></tr>
<tr><td>script_witnesses</td></tr>
<tr><td>script_witnesses[]</td></tr>
<tr><td>The witness structure as a serialized byte array</td></tr>
<tr><td>4</td></tr>
<tr><td>lock_time</td></tr>
<tr><td>uint32_t</td></tr>
<tr><td>The block number or timestamp until which the transaction is locked</td></tr>
</tbody></table>
<p>Parsers supporting this BIP will be able to distinguish between the old serialization format (without the witness) and this one. The marker byte is set to zero so that this structure will never parse as a valid transaction in a parser that does not support this BIP. If parsing were to succeed, such a transaction would contain no inputs and a single output.</p>
<p>If the witness is empty, the old serialization format must be used. </p>
<p>Currently, the only witness objects type supported are script witnesses which consist of a stack of byte arrays. It is encoded as a var_int item count followed by each item encoded as a var_int length followed by a string of bytes. Each txin has its own script witness. The number of script witnesses is not explicitly encoded as it is implied by txin_count. Empty script witnesses are encoded as a zero byte. The order of the script witnesses follows the same order as the associated txins.</p>
<ul>
<li>
<p><strong>Rationale for not having an independent message type with its own serialization</strong>: this would require separate &quot;tx&quot; and &quot;block&quot; messages, and all RPC calls operating on raw transactions would need to be duplicated, or need inefficient or nondeterministic guesswork to know which type is to be used.</p>
</li>
<li>
<p><strong>Rationale for not using just a single 0x00 byte as marker</strong>: that would lead to empty transactions (no inputs, no outputs, which are used in some tests) to be interpreted as new serialized data.</p>
</li>
<li>
<p><strong>Rationale for the 0x01 flag byte in between</strong>: this will allow us to easily add more extra non-committed data to transactions (like txouts being spent, ...). It can be interpreted as a bitvector.</p>
</li>
</ul>
<h3> Handshake </h3>
<p>A node will signal that it can provide witnesses using the following service bit</p>
<pre><code>    NODE_WITNESS = (1 &lt;&lt; 3)
	
</code></pre>
<h3> Hashes </h3>
<p>Transaction hashes used in the transaction merkle tree and txin outpoints are always computed using the old non-witness
serialization.</p>
<p>Support for a new hash including the witness data is added that is
computed from the new witness serialization. (Note that transactions
with an empty witness always use the old serialization,
and therefore, they have witness hash equal to normal hash.)</p>
<p><img src=bip-0144/witnesstx.png></img></p>
<h3> Relay </h3>
<p>New inv types MSG_WITNESS_TX (0x40000001, or (1&lt;&lt;30)+MSG_TX) and MSG_WITNESS_BLOCK (0x40000002, or (1&lt;&lt;30)+MSG_BLOCK) are added, only
for use in getdata. Inventory messages themselves still use just MSG_TX and MSG_BLOCK,
similar to MSG_FILTERED_BLOCK. A further inv type MSG_FILTERED_WITNESS_BLOCK (0x40000003, or (1&lt;&lt;30)+MSG_FILTERED_BLOCK) is reserved for future use.</p>
<ul>
<li><strong>Rationale for not advertizing witnessness in invs</strong>: we don't always use invs anymore (with 'sendheaders' BIP 130), plus it's not useful: implicitly, every transaction and block have a witness, old ones just have empty ones.</li>
</ul>
<p>MSG_WITNESS_TX getdata requests should use the non-witness serialized hash. The peer shall respond with a tx message, and if the witness structure is nonempty, the witness serialization shall be used.</p>
<p>MSG_WITNESS_BLOCK requests will return a block message with transactions that have a witness using witness serialization.</p>
<h2> Credits </h2>
<p>Special thanks to Gregory Maxwell for originating many of the ideas in this BIP and Luke-Jr for figuring out how to deploy this as a soft fork.</p>
<h2> Reference Implementation </h2>
<p>https://github.com/bitcoin/bitcoin/pull/8149</p>
<h2> Copyright </h2>
<p>This document is placed in the public domain.</p>

    </div>
    -->


            <hr class="border-slate-700" />

            <div class="w-full flex flex-col items-center space-y-2">
                <div class="flex items-center space-x-2">
                    <p class="font-bold">Updated</p>
                    <p class="font-bold">2024-03-05</p>
                </div>
                <p><a href="/">bips.dev</a> is presented by <a href="https://nickmonad.blog" target="_blank">nickmonad</a></p>
                <p>Check it out <a href="https://github.com/nickmonad/bips.dev" target="_blank">GitHub</a></p>
                <p>Stay humble. Stack sats.</p>
                <p class="pt-2 text-sm">All content is owned and licensed by the respective author(s). This website makes no claim of ownership.</p>
            </div>
        </div>
    </div>

    <!--
    <footer class="footer">
        <div class="container has-text-centered has-text-weight-bold is-family-monospace">
            <p class="mb-1">Updated <span class="tag is-medium is-warning is-light">2024-03-05</span></p>
            <p>bips.dev - Made with ☕ by <a href="https://nickmonad.blog">nickmonad</a></p>
            <p>Check it out on <a href="https://github.com/nickmonad/bips-dev">GitHub</a></p>
            <p>Stay humble. Stack sats. ₿</p>
        </div>
    </footer>
    -->

    <script>

    </script>
</body>
</html>
